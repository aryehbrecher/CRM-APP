<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Mortgage CRM</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè¶</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Sora','DM Sans',system-ui,sans-serif;background:#0d1117;color:#c8d1da}
::placeholder{color:#3d4f5f}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-thumb{background:#1a2332;border-radius:3px}
input:focus,select:focus,textarea:focus{border-color:#22d3ee!important;outline:none}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .25s ease-out}
</style>
</head>
<body>
<div id="root"></div>
<script>
// ‚ïê‚ïê‚ïê FIREBASE INIT ‚ïê‚ïê‚ïê
const firebaseConfig = {
  apiKey: "AIzaSyB5HbJFcseIeVwlgPBNKw_OT18YNuNPZJE",
  authDomain: "aryehcrm.firebaseapp.com",
  databaseURL: "https://aryehcrm-default-rtdb.firebaseio.com",
  projectId: "aryehcrm",
  storageBucket: "aryehcrm.firebasestorage.app",
  messagingSenderId: "863517978050",
  appId: "1:863517978050:web:ea8961419c0a2bcda13a5b",
  measurementId: "G-08CV09Y9DQ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const dealsRef = db.ref("deals");
window.__firebaseDB = { db, dealsRef };
</script>
<script type="text/babel">
const{useState,useEffect,useCallback,useMemo,useRef}=React;
const dealsRef = window.__firebaseDB.dealsRef;

const STAGES={
  active_lead:{label:"Active Leads",icon:"‚ö°",accent:"#22d3ee"},
  old_lead:{label:"Old Leads",icon:"üìÅ",accent:"#a78bfa"},
  pre_approval:{label:"Pre-Approvals",icon:"üìã",accent:"#fbbf24"},
  active_deal:{label:"Active Deals",icon:"üè†",accent:"#34d399"},
  closed_deal:{label:"Closed Deals",icon:"‚úÖ",accent:"#6ee7b7"},
};
const DEAL_TYPES=["Purchase","Refinance"];
const REMINDER_RULES={
  active_lead:{days:[1,4],type:"weekly",label:"Follow up every Mon & Thu"},
  old_lead:{intervalDays:30,type:"interval",label:"Follow up every 30 days"},
  pre_approval:{intervalDays:30,type:"interval",label:"Follow up every 30 days"},
  active_deal:{type:"none",label:"No scheduled follow-up"},
  closed_deal:{type:"none",label:"No scheduled follow-up"},
};
const NAV_ITEMS=[
  {key:"dashboard",label:"Dashboard",icon:"‚óâ"},
  {key:"active_lead",label:"Active Leads",icon:"‚ö°"},
  {key:"old_lead",label:"Old Leads",icon:"üìÅ"},
  {key:"pre_approval",label:"Pre-Approvals",icon:"üìã"},
  {key:"active_deal",label:"Active Deals",icon:"üè†"},
  {key:"closed_deal",label:"Closed Deals",icon:"‚úÖ"},
];

const uid=()=>Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,8);
const formatPhone=val=>{const d=val.replace(/\D/g,"").slice(0,10);if(d.length<=3)return d;if(d.length<=6)return"("+d.slice(0,3)+") "+d.slice(3);return"("+d.slice(0,3)+") "+d.slice(3,6)+"-"+d.slice(6);};
const dayName=d=>["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][d];
const fmtDate=iso=>iso?new Date(iso).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"‚Äî";
const daysBetween=(a,b)=>Math.floor((new Date(b)-new Date(a))/86400000);
const getToday=()=>new Date().toISOString().split("T")[0];
const todayDow=()=>new Date().getDay();

function isDueToday(deal){
  const r=REMINDER_RULES[deal.stage];
  if(!r||r.type==="none")return false;
  if(r.type==="weekly")return r.days.includes(todayDow());
  if(r.type==="interval"){const l=deal.lastFollowUp||deal.stageEnteredAt||deal.createdAt;return daysBetween(l,getToday())>=r.intervalDays;}
  return false;
}
function getNextDue(deal){
  const r=REMINDER_RULES[deal.stage];
  if(!r||r.type==="none")return null;
  if(r.type==="weekly"){const dow=todayDow();const diffs=r.days.map(d=>{let x=d-dow;if(x<=0)x+=7;return x;});const nd=new Date();nd.setDate(nd.getDate()+Math.min(...diffs));return nd.toISOString().split("T")[0];}
  if(r.type==="interval"){const l=deal.lastFollowUp||deal.stageEnteredAt||deal.createdAt;const nd=new Date(l);nd.setDate(nd.getDate()+r.intervalDays);return nd.toISOString().split("T")[0];}
  return null;
}

function Overlay({children,close,wide}){return(
  <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,.55)",backdropFilter:"blur(4px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:999,padding:20}} onClick={close}>
    <div className="fade-in" style={{background:"#111820",borderRadius:16,padding:26,border:"1px solid rgba(255,255,255,.07)",width:"100%",maxWidth:wide?600:460,maxHeight:"90vh",overflowY:"auto",boxShadow:"0 20px 60px rgba(0,0,0,.5)"}} onClick={e=>e.stopPropagation()}>{children}</div>
  </div>
);}
function Section({icon,title,badge,badgeColor,children}){return(
  <div style={{background:"rgba(255,255,255,.02)",borderRadius:14,border:"1px solid rgba(255,255,255,.05)",overflow:"hidden"}}>
    <div style={{padding:"14px 20px",borderBottom:"1px solid rgba(255,255,255,.04)",display:"flex",alignItems:"center",gap:8}}>
      <span style={{fontSize:15}}>{icon}</span>
      <span style={{fontWeight:600,color:"#f0f4f8",fontSize:14}}>{title}</span>
      <span style={{marginLeft:"auto",fontSize:11,background:badgeColor||"rgba(255,255,255,.05)",color:badgeColor?"#0a0e14":"#4a5568",padding:"1px 8px",borderRadius:8,fontWeight:700}}>{badge}</span>
    </div>
    {children}
  </div>
);}
function Field({label,children}){return<div style={{display:"flex",flexDirection:"column",gap:5}}><label style={lbl}>{label}</label>{children}</div>;}
function Empty({children}){return<div style={{padding:40,textAlign:"center",color:"#2d3d4d",fontSize:13}}>{children}</div>;}

const lbl={fontSize:10,fontWeight:600,color:"#4a5568",textTransform:"uppercase",letterSpacing:".07em",display:"block"};
const inp={width:"100%",padding:"9px 12px",borderRadius:8,border:"1px solid rgba(255,255,255,.07)",background:"rgba(255,255,255,.02)",color:"#c8d1da",fontSize:13,outline:"none",fontFamily:"inherit",boxSizing:"border-box"};
const btnPrimary={padding:"9px 18px",borderRadius:8,border:"none",background:"linear-gradient(135deg,#22d3ee,#6366f1)",color:"#fff",fontWeight:600,fontSize:13,cursor:"pointer",fontFamily:"inherit"};
const btnGhost={padding:"8px 16px",borderRadius:8,border:"1px solid rgba(255,255,255,.08)",background:"transparent",color:"#6b7b8d",fontSize:13,cursor:"pointer",fontFamily:"inherit"};
const btnSm={padding:"5px 12px",borderRadius:6,fontSize:12,cursor:"pointer",fontFamily:"inherit",fontWeight:500};

function App(){
  const[deals,setDeals]=useState([]);
  const[page,setPage]=useState("dashboard");
  const[modal,setModal]=useState(null);
  const[formData,setFormData]=useState({});
  const[editId,setEditId]=useState(null);
  const[detailDeal,setDetailDeal]=useState(null);
  const[toast,setToast]=useState(null);
  const[search,setSearch]=useState("");
  const[needsInput,setNeedsInput]=useState("");
  const[sidebarOpen,setSidebarOpen]=useState(window.innerWidth>768);
  const[loaded,setLoaded]=useState(false);
  const[connected,setConnected]=useState(true);

  // ‚ïê‚ïê‚ïê FIREBASE REALTIME LISTENER ‚ïê‚ïê‚ïê
  useEffect(()=>{
    const connRef=firebase.database().ref(".info/connected");
    connRef.on("value",snap=>setConnected(!!snap.val()));

    dealsRef.on("value",snapshot=>{
      const data=snapshot.val();
      if(data){
        const arr=Object.entries(data).map(([id,deal])=>({...deal,id}));
        // Auto-age active leads > 30 days
        const t=getToday();
        let changed=false;
        const aged=arr.map(d=>{
          if(d.stage==="active_lead"&&daysBetween(d.stageEnteredAt||d.createdAt,t)>=30){
            changed=true;
            return{...d,stage:"old_lead",stageEnteredAt:t};
          }
          return d;
        });
        if(changed) aged.filter(d=>d.stage==="old_lead").forEach(d=>dealsRef.child(d.id).update({stage:"old_lead",stageEnteredAt:t}));
        setDeals(aged);
      } else {
        setDeals([]);
      }
      setLoaded(true);
    });

    return()=>{dealsRef.off();connRef.off();};
  },[]);

  const flash=msg=>{setToast(msg);setTimeout(()=>setToast(null),2500);};

  // ‚ïê‚ïê‚ïê FIREBASE CRUD ‚ïê‚ïê‚ïê
  const saveDeal=()=>{
    if(!formData.name?.trim())return flash("Deal name is required");
    const now=new Date().toISOString();
    if(editId){
      const{id,...rest}=formData;
      dealsRef.child(editId).update(rest);
      flash("Deal updated");
    } else {
      const newId=uid();
      dealsRef.child(newId).set({
        name:formData.name,
        phone:formData.phone||"",
        type:formData.type||"Purchase",
        referral:formData.referral||"",
        stage:formData.stage||"active_lead",
        createdAt:now,
        stageEnteredAt:now,
        lastFollowUp:null,
        needsList:{},
        notes:formData.notes||""
      });
      flash("Deal added");
    }
    setModal(null);setEditId(null);setFormData({});
  };

  const deleteDeal=id=>{dealsRef.child(id).remove();setModal(null);setDetailDeal(null);flash("Deal deleted");};

  const moveStage=(deal,ns)=>{
    const now=new Date().toISOString();
    dealsRef.child(deal.id).update({stage:ns,stageEnteredAt:now});
    setDetailDeal({...deal,stage:ns,stageEnteredAt:now});
    flash("Moved to "+STAGES[ns].label);
  };

  const markFollowedUp=deal=>{
    dealsRef.child(deal.id).update({lastFollowUp:getToday()});
    flash("Marked as followed up");
  };

  const addNeedsItem=deal=>{
    if(!needsInput.trim())return;
    const itemId=uid();
    const item={text:needsInput.trim(),done:false,addedAt:new Date().toISOString()};
    dealsRef.child(deal.id+"/needsList/"+itemId).set(item);
    setNeedsInput("");
    flash("Item added");
  };

  const toggleNeedsItem=(deal,itemId)=>{
    const item=getNeedsList(deal).find(n=>n.id===itemId);
    if(item) dealsRef.child(deal.id+"/needsList/"+itemId).update({done:!item.done});
  };

  const removeNeedsItem=(deal,itemId)=>{
    dealsRef.child(deal.id+"/needsList/"+itemId).remove();
  };

  // Firebase stores needsList as object, convert to array
  const getNeedsList=(deal)=>{
    if(!deal.needsList) return [];
    if(Array.isArray(deal.needsList)) return deal.needsList;
    return Object.entries(deal.needsList).map(([id,item])=>({...item,id}));
  };

  const todaysTasks=useMemo(()=>deals.filter(isDueToday),[deals]);
  const openNeedsDeals=useMemo(()=>deals.filter(d=>d.stage==="active_deal"&&getNeedsList(d).some(n=>!n.done)),[deals]);
  const stageDeals=stage=>deals.filter(d=>d.stage===stage&&(!search||d.name.toLowerCase().includes(search.toLowerCase())||(d.referral||"").toLowerCase().includes(search.toLowerCase())));
  const stageCounts=useMemo(()=>Object.keys(STAGES).reduce((a,s)=>{a[s]=deals.filter(d=>d.stage===s).length;return a;},{}),[deals]);

  if(!loaded) return(
    <div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"100vh",background:"#0d1117",color:"#5b6b7a",gap:12}}>
      <div style={{width:36,height:36,border:"3px solid #1a2332",borderTopColor:"#22d3ee",borderRadius:"50%",animation:"spin .8s linear infinite"}}/>
      <style>{"@keyframes spin{to{transform:rotate(360deg)}}"}</style>
      <p>Connecting to database...</p>
    </div>
  );

  return(
    <div style={{display:"flex",minHeight:"100vh",background:"#0d1117",fontFamily:"'Sora','DM Sans',system-ui,sans-serif",color:"#c8d1da"}}>

      {toast&&<div style={{position:"fixed",top:20,right:20,background:"#1c6e3d",color:"#d1fae5",padding:"10px 22px",borderRadius:10,fontSize:13,fontWeight:600,zIndex:9999,boxShadow:"0 8px 30px rgba(0,0,0,.4)"}}>{toast}</div>}

      {/* Connection status */}
      {!connected&&<div style={{position:"fixed",bottom:20,left:"50%",transform:"translateX(-50%)",background:"#92400e",color:"#fef3c7",padding:"8px 20px",borderRadius:10,fontSize:12,fontWeight:600,zIndex:9999}}>‚ö† Offline ‚Äî changes will sync when reconnected</div>}

      {/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */}
      <aside style={{width:sidebarOpen?230:58,background:"#0a0e14",borderRight:"1px solid rgba(255,255,255,.05)",display:"flex",flexDirection:"column",transition:"width .2s",overflow:"hidden",flexShrink:0}}>
        <div style={{padding:sidebarOpen?"20px 16px 10px":"20px 11px 10px",display:"flex",alignItems:"center",gap:10,cursor:"pointer"}} onClick={()=>setSidebarOpen(!sidebarOpen)}>
          <div style={{width:36,height:36,borderRadius:10,background:"linear-gradient(135deg,#22d3ee,#6366f1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:17,flexShrink:0}}>üè¶</div>
          {sidebarOpen&&<span style={{fontWeight:700,fontSize:15,color:"#f0f4f8",letterSpacing:"-.02em",whiteSpace:"nowrap"}}>Mortgage CRM</span>}
        </div>
        <nav style={{flex:1,padding:"8px 0",display:"flex",flexDirection:"column",gap:1}}>
          {NAV_ITEMS.map(item=>{
            const active=page===item.key;const cnt=item.key==="dashboard"?todaysTasks.length:stageCounts[item.key]||0;
            return(
              <div key={item.key} onClick={()=>{setPage(item.key);setSearch("");setModal(null);setDetailDeal(null);}}
                style={{display:"flex",alignItems:"center",gap:10,padding:sidebarOpen?"9px 16px":"9px 17px",cursor:"pointer",background:active?"rgba(255,255,255,.05)":"transparent",borderLeft:active?"3px solid #22d3ee":"3px solid transparent",transition:"all .15s",whiteSpace:"nowrap"}}>
                <span style={{fontSize:14,flexShrink:0,width:22,textAlign:"center"}}>{item.icon}</span>
                {sidebarOpen&&<>
                  <span style={{fontSize:13,fontWeight:active?600:400,color:active?"#f0f4f8":"#5b6b7a",flex:1}}>{item.label}</span>
                  {cnt>0&&<span style={{fontSize:10,fontWeight:700,background:active?"#22d3ee":"rgba(255,255,255,.06)",color:active?"#0a0e14":"#5b6b7a",padding:"1px 7px",borderRadius:8,minWidth:20,textAlign:"center"}}>{cnt}</span>}
                </>}
              </div>
            );
          })}
        </nav>
        {sidebarOpen&&<div style={{padding:"12px 16px 16px",borderTop:"1px solid rgba(255,255,255,.04)"}}>
          <button onClick={()=>{setFormData({stage:page!=="dashboard"?page:"active_lead"});setEditId(null);setModal("add");}}
            style={{width:"100%",padding:10,borderRadius:10,border:"none",background:"linear-gradient(135deg,#22d3ee,#6366f1)",color:"#fff",fontWeight:600,fontSize:13,cursor:"pointer",fontFamily:"inherit"}}>+ New Deal</button>
        </div>}
      </aside>

      {/* ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê */}
      <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
        <header style={{padding:"14px 28px",borderBottom:"1px solid rgba(255,255,255,.04)",display:"flex",alignItems:"center",justifyContent:"space-between",background:"#0d1117",flexWrap:"wrap",gap:10}}>
          <div>
            <h1 style={{fontSize:21,fontWeight:700,color:"#f0f4f8",margin:0,letterSpacing:"-.03em"}}>{page==="dashboard"?"Dashboard":STAGES[page]?.label}</h1>
            <p style={{fontSize:12,color:"#4a5568",margin:"2px 0 0"}}>
              {page==="dashboard"
                ?dayName(todayDow())+", "+fmtDate(getToday())+" ¬∑ "+todaysTasks.length+" follow-up"+(todaysTasks.length!==1?"s":"")+" due"
                :(stageCounts[page]||0)+" deal"+((stageCounts[page]||0)!==1?"s":"")
              }
            </p>
          </div>
          <div style={{display:"flex",alignItems:"center",gap:10}}>
            <div style={{width:8,height:8,borderRadius:"50%",background:connected?"#34d399":"#f59e0b"}} title={connected?"Connected":"Offline"}/>
            {page!=="dashboard"&&<input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search deals..." style={{padding:"8px 14px",borderRadius:8,border:"1px solid rgba(255,255,255,.07)",background:"rgba(255,255,255,.02)",color:"#c8d1da",fontSize:13,width:200,fontFamily:"inherit"}}/>}
          </div>
        </header>

        <main style={{flex:1,overflowY:"auto",padding:"20px 28px 40px"}}>

          {/* ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê */}
          {page==="dashboard"&&<div style={{display:"flex",flexDirection:"column",gap:22}}>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(130px,1fr))",gap:10}}>
              {Object.entries(STAGES).map(([k,s])=>(
                <div key={k} onClick={()=>setPage(k)}
                  style={{padding:"14px 16px",background:"rgba(255,255,255,.02)",borderRadius:12,border:"1px solid rgba(255,255,255,.05)",cursor:"pointer",transition:"border-color .15s"}}
                  onMouseEnter={e=>e.currentTarget.style.borderColor=s.accent} onMouseLeave={e=>e.currentTarget.style.borderColor="rgba(255,255,255,.05)"}>
                  <div style={{fontSize:10,color:"#4a5568",fontWeight:600,marginBottom:5,textTransform:"uppercase",letterSpacing:".06em"}}>{s.label}</div>
                  <div style={{fontSize:26,fontWeight:700,color:s.accent}}>{stageCounts[k]||0}</div>
                </div>
              ))}
            </div>

            <Section icon="üîî" title="Today's Follow-Ups" badge={todaysTasks.length} badgeColor={todaysTasks.length>0?"#fbbf24":null}>
              {todaysTasks.length===0?<Empty>No follow-ups due today ‚Äî you're all caught up!</Empty>:
                todaysTasks.map(deal=>(
                  <div key={deal.id} style={{display:"flex",alignItems:"center",padding:"11px 20px",borderBottom:"1px solid rgba(255,255,255,.03)",gap:12,flexWrap:"wrap"}}>
                    <div style={{flex:1,minWidth:150}}>
                      <span style={{fontWeight:600,color:"#f0f4f8",fontSize:14,cursor:"pointer"}} onClick={()=>{setDetailDeal(deal);setModal("detail");}}>{deal.name}</span>
                      <span style={{color:"#4a5568",fontSize:12,marginLeft:10}}>{STAGES[deal.stage].label}</span>
                      {deal.phone&&<span style={{color:"#3d4f5f",fontSize:12,marginLeft:10}}>{deal.phone}</span>}
                    </div>
                    <span style={{fontSize:11,color:"#4a5568"}}>{REMINDER_RULES[deal.stage].label}</span>
                    <button onClick={()=>markFollowedUp(deal)} style={{...btnSm,background:"#1c6e3d",color:"#d1fae5",border:"none"}}>Done</button>
                  </div>
                ))}
            </Section>

            <Section icon="üìù" title="Outstanding Borrower Needs" badge={openNeedsDeals.length} badgeColor={openNeedsDeals.length>0?"#ef4444":null}>
              {openNeedsDeals.length===0?<Empty>No outstanding items ‚Äî all clear!</Empty>:
                openNeedsDeals.map(deal=>{
                  const items=getNeedsList(deal).filter(n=>!n.done);
                  return(
                    <div key={deal.id} style={{padding:"12px 20px",borderBottom:"1px solid rgba(255,255,255,.03)"}}>
                      <div style={{fontWeight:600,color:"#f0f4f8",fontSize:14,marginBottom:6,cursor:"pointer"}} onClick={()=>{setDetailDeal(deal);setModal("detail");}}>{deal.name}</div>
                      {items.map(item=>(
                        <div key={item.id} style={{display:"flex",alignItems:"center",gap:8,padding:"3px 0 3px 14px"}}>
                          <span style={{width:5,height:5,borderRadius:"50%",background:"#ef4444",flexShrink:0}}/>
                          <span style={{fontSize:13,color:"#8899a6"}}>{item.text}</span>
                        </div>
                      ))}
                    </div>
                  );
                })}
            </Section>
          </div>}

          {/* ‚ïê‚ïê‚ïê STAGE PAGES ‚ïê‚ïê‚ïê */}
          {page!=="dashboard"&&modal!=="detail"&&<>
            <div style={{background:"rgba(255,255,255,.02)",borderRadius:14,border:"1px solid rgba(255,255,255,.05)",overflow:"hidden"}}>
              <div style={{display:"grid",gridTemplateColumns:"1fr 120px 90px 1fr 100px 50px",padding:"10px 20px",borderBottom:"1px solid rgba(255,255,255,.06)",fontSize:10,fontWeight:600,color:"#3d4f5f",textTransform:"uppercase",letterSpacing:".07em"}}>
                <span>Deal Name</span><span>Contact #</span><span>Type</span><span>Referred By</span><span>Created</span><span style={{textAlign:"right"}}>Needs</span>
              </div>
              {stageDeals(page).length===0?<Empty>No deals in {STAGES[page].label}</Empty>:
                stageDeals(page).map(deal=>{
                  const due=isDueToday(deal);const openN=getNeedsList(deal).filter(n=>!n.done).length;
                  return(
                    <div key={deal.id} onClick={()=>{setDetailDeal(deal);setModal("detail");}}
                      style={{display:"grid",gridTemplateColumns:"1fr 120px 90px 1fr 100px 50px",alignItems:"center",padding:"13px 20px",background:due?"rgba(251,191,36,.05)":"transparent",borderBottom:"1px solid rgba(255,255,255,.03)",cursor:"pointer",transition:"background .12s"}}
                      onMouseEnter={e=>e.currentTarget.style.background="rgba(255,255,255,.03)"} onMouseLeave={e=>e.currentTarget.style.background=due?"rgba(251,191,36,.05)":"transparent"}>
                      <div style={{display:"flex",alignItems:"center",gap:8}}>
                        {due&&<span style={{width:6,height:6,borderRadius:"50%",background:"#fbbf24",flexShrink:0}}/>}
                        <span style={{fontWeight:600,color:"#f0f4f8",fontSize:14}}>{deal.name}</span>
                      </div>
                      <span style={{color:"#6b7b8d",fontSize:13}}>{deal.phone||"‚Äî"}</span>
                      <span style={{fontSize:11,fontWeight:600,padding:"3px 9px",borderRadius:5,background:deal.type==="Purchase"?"rgba(34,211,238,.1)":"rgba(167,139,250,.1)",color:deal.type==="Purchase"?"#22d3ee":"#a78bfa",textAlign:"center",justifySelf:"start"}}>{deal.type}</span>
                      <span style={{color:"#6b7b8d",fontSize:13}}>{deal.referral||"‚Äî"}</span>
                      <span style={{color:"#3d4f5f",fontSize:12}}>{fmtDate(deal.createdAt)}</span>
                      <div style={{textAlign:"right"}}>{openN>0&&<span style={{fontSize:10,fontWeight:700,background:"#ef4444",color:"#fff",padding:"2px 6px",borderRadius:7}}>{openN}</span>}</div>
                    </div>
                  );
                })}
            </div>
            <div style={{marginTop:14,fontSize:12,color:"#3d4f5f",display:"flex",gap:16,flexWrap:"wrap"}}>
              <span>üìÖ {REMINDER_RULES[page].label}</span>
              {page==="active_lead"&&<span>‚è± Auto-moves to Old Leads after 30 days</span>}
            </div>
          </>}
        </main>
      </div>

      {/* ‚ïê‚ïê‚ïê ADD/EDIT MODAL ‚ïê‚ïê‚ïê */}
      {(modal==="add"||modal==="edit")&&<Overlay close={()=>{setModal(null);setEditId(null);}}>
        <h2 style={{fontSize:18,fontWeight:700,color:"#f0f4f8",margin:"0 0 18px"}}>{modal==="edit"?"Edit Deal":"Add New Deal"}</h2>
        <div style={{display:"flex",flexDirection:"column",gap:13}}>
          <Field label="Deal Name *"><input style={inp} value={formData.name||""} onChange={e=>setFormData({...formData,name:e.target.value})} placeholder="Smith Family Home Purchase"/></Field>
          <Field label="Contact Number"><input style={inp} value={formData.phone||""} onChange={e=>setFormData({...formData,phone:formatPhone(e.target.value)})} placeholder="(555) 123-4567"/></Field>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
            <Field label="Type"><select style={inp} value={formData.type||"Purchase"} onChange={e=>setFormData({...formData,type:e.target.value})}>{DEAL_TYPES.map(t=><option key={t}>{t}</option>)}</select></Field>
            <Field label="Stage"><select style={inp} value={formData.stage||"active_lead"} onChange={e=>setFormData({...formData,stage:e.target.value})}>{Object.entries(STAGES).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}</select></Field>
          </div>
          <Field label="Referred By"><input style={inp} value={formData.referral||""} onChange={e=>setFormData({...formData,referral:e.target.value})} placeholder="Agent name, past client, etc."/></Field>
          <Field label="Notes"><textarea style={{...inp,minHeight:60,resize:"vertical"}} value={formData.notes||""} onChange={e=>setFormData({...formData,notes:e.target.value})} placeholder="Optional notes..."/></Field>
        </div>
        <div style={{display:"flex",justifyContent:"flex-end",gap:10,marginTop:20}}>
          <button onClick={()=>{setModal(null);setEditId(null);}} style={btnGhost}>Cancel</button>
          <button onClick={saveDeal} style={btnPrimary}>{modal==="edit"?"Update":"Add Deal"}</button>
        </div>
      </Overlay>}

      {/* ‚ïê‚ïê‚ïê DETAIL MODAL ‚ïê‚ïê‚ïê */}
      {modal==="detail"&&detailDeal&&(()=>{
        const deal=deals.find(d=>d.id===detailDeal.id)||detailDeal;
        const stage=STAGES[deal.stage];
        const allNeeds=getNeedsList(deal);
        const openN=allNeeds.filter(n=>!n.done);
        const doneN=allNeeds.filter(n=>n.done);
        const nextDue=getNextDue(deal);
        return(
          <Overlay close={()=>{setModal(null);setDetailDeal(null);}} wide>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:18,flexWrap:"wrap",gap:10}}>
              <div>
                <h2 style={{fontSize:20,fontWeight:700,color:"#f0f4f8",margin:0}}>{deal.name}</h2>
                <div style={{display:"flex",gap:7,marginTop:7,flexWrap:"wrap",alignItems:"center"}}>
                  <span style={{fontSize:11,fontWeight:600,padding:"3px 9px",borderRadius:5,background:deal.type==="Purchase"?"rgba(34,211,238,.1)":"rgba(167,139,250,.1)",color:deal.type==="Purchase"?"#22d3ee":"#a78bfa"}}>{deal.type}</span>
                  <span style={{fontSize:11,fontWeight:600,padding:"3px 9px",borderRadius:5,background:stage.accent+"20",color:stage.accent}}>{stage.label}</span>
                  {deal.phone&&<span style={{fontSize:13,color:"#6b7b8d",marginLeft:4}}>üìû {deal.phone}</span>}
                </div>
              </div>
              <div style={{display:"flex",gap:6}}>
                <button onClick={()=>{setFormData({...deal});setEditId(deal.id);setModal("edit");}} style={{...btnSm,...btnGhost}}>Edit</button>
                <button onClick={()=>{if(confirm("Delete this deal?"))deleteDeal(deal.id);}} style={{...btnSm,border:"1px solid rgba(239,68,68,.2)",background:"rgba(239,68,68,.07)",color:"#fca5a5"}}>Delete</button>
              </div>
            </div>

            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:13,marginBottom:18}}>
              {[["Contact #",deal.phone],["Referred By",deal.referral],["Created",fmtDate(deal.createdAt)],["In Stage Since",fmtDate(deal.stageEnteredAt)],["Next Follow-Up",nextDue?fmtDate(nextDue):"None"]].map(([l,v])=>(
                <div key={l}><span style={lbl}>{l}</span><div style={{color:l==="Next Follow-Up"&&nextDue?"#fbbf24":"#c8d1da",fontSize:14,marginTop:3}}>{v||"‚Äî"}</div></div>
              ))}
            </div>

            {deal.notes&&<div style={{marginBottom:18}}><span style={lbl}>Notes</span><p style={{color:"#6b7b8d",fontSize:13,lineHeight:1.5,marginTop:3}}>{deal.notes}</p></div>}

            <div style={{marginBottom:18,paddingTop:14,borderTop:"1px solid rgba(255,255,255,.04)"}}>
              <span style={lbl}>Move to Stage</span>
              <div style={{display:"flex",gap:7,marginTop:8,flexWrap:"wrap"}}>
                {Object.keys(STAGES).filter(k=>k!==deal.stage).map(k=>(
                  <button key={k} onClick={()=>moveStage(deal,k)}
                    style={{padding:"5px 12px",borderRadius:7,border:"1px solid rgba(255,255,255,.07)",background:"rgba(255,255,255,.02)",color:STAGES[k].accent,fontSize:12,fontWeight:500,cursor:"pointer",fontFamily:"inherit"}}>{STAGES[k].icon} {STAGES[k].label}</button>
                ))}
              </div>
            </div>

            <div style={{paddingTop:14,borderTop:"1px solid rgba(255,255,255,.04)"}}>
              <span style={lbl}>Items Needed from Borrower</span>
              <div style={{display:"flex",gap:8,marginTop:10}}>
                <input value={needsInput} onChange={e=>setNeedsInput(e.target.value)} onKeyDown={e=>e.key==="Enter"&&addNeedsItem(deal)} placeholder="e.g. W-2s, bank statements..." style={{...inp,flex:1}}/>
                <button onClick={()=>addNeedsItem(deal)} style={{...btnPrimary,fontSize:12,padding:"8px 14px"}}>Add</button>
              </div>
              <div style={{marginTop:8}}>
                {openN.length===0&&doneN.length===0&&<div style={{color:"#2d3d4d",fontSize:13,padding:"14px 0"}}>No items tracked yet</div>}
                {openN.map(item=>(
                  <div key={item.id} style={{display:"flex",alignItems:"center",gap:10,padding:"7px 0",borderBottom:"1px solid rgba(255,255,255,.025)"}}>
                    <div onClick={()=>toggleNeedsItem(deal,item.id)} style={{width:18,height:18,borderRadius:4,border:"2px solid #3d4f5f",cursor:"pointer",flexShrink:0}}/>
                    <span style={{flex:1,fontSize:13,color:"#c8d1da"}}>{item.text}</span>
                    <span style={{fontSize:10,color:"#2d3d4d"}}>{fmtDate(item.addedAt)}</span>
                    <button onClick={()=>removeNeedsItem(deal,item.id)} style={{background:"none",border:"none",color:"#3d4f5f",cursor:"pointer",fontSize:15,padding:0,lineHeight:1}}>√ó</button>
                  </div>
                ))}
                {doneN.length>0&&<div style={{marginTop:8}}>
                  <span style={{fontSize:10,color:"#2d3d4d",fontWeight:500}}>Completed ({doneN.length})</span>
                  {doneN.map(item=>(
                    <div key={item.id} style={{display:"flex",alignItems:"center",gap:10,padding:"5px 0",opacity:.45}}>
                      <div onClick={()=>toggleNeedsItem(deal,item.id)} style={{width:18,height:18,borderRadius:4,background:"#1c6e3d",border:"2px solid #1c6e3d",cursor:"pointer",flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:10,fontWeight:700}}>‚úì</div>
                      <span style={{flex:1,fontSize:13,color:"#4a5568",textDecoration:"line-through"}}>{item.text}</span>
                      <button onClick={()=>removeNeedsItem(deal,item.id)} style={{background:"none",border:"none",color:"#2d3d4d",cursor:"pointer",fontSize:15,padding:0,lineHeight:1}}>√ó</button>
                    </div>
                  ))}
                </div>}
              </div>
            </div>

            <div style={{display:"flex",justifyContent:"flex-end",marginTop:18}}>
              <button onClick={()=>{setModal(null);setDetailDeal(null);}} style={btnGhost}>Close</button>
            </div>
          </Overlay>
        );
      })()}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
